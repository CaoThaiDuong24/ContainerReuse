# ğŸš€ Cáº¥u hÃ¬nh API thá»±c cho Depot

## âœ… ÄÃ£ hoÃ n thÃ nh

Há»‡ thá»‘ng Ä‘Ã£ Ä‘Æ°á»£c cáº¥u hÃ¬nh Ä‘á»ƒ láº¥y dá»¯ liá»‡u depot tá»« API thá»±c thay vÃ¬ mock data:

### ğŸ“ Files Ä‘Ã£ táº¡o/cáº­p nháº­t:

1. **`backend/src/services/depotApiService.ts`** - Service má»›i Ä‘á»ƒ gá»i API thá»±c
2. **`backend/src/controllers/depotController.ts`** - ÄÃ£ cáº­p nháº­t Ä‘á»ƒ sá»­ dá»¥ng API thá»±c
3. **`backend/.env`** - File cáº¥u hÃ¬nh mÃ´i trÆ°á»ng
4. **`backend/src/test-real-api.ts`** - Script test káº¿t ná»‘i API thá»±c

---

## ğŸ”§ Cáº¥u hÃ¬nh

### BÆ°á»›c 1: Cáº¥u hÃ¬nh URL API

Má»Ÿ file `backend/.env` vÃ  thay Ä‘á»•i `EXTERNAL_API_URL`:

```env
# Thay Ä‘á»•i URL nÃ y thÃ nh URL API thá»±c cá»§a báº¡n
EXTERNAL_API_URL=https://your-external-api-url.com
```

**VÃ­ dá»¥:**
```env
EXTERNAL_API_URL=https://api.containerhub.com
EXTERNAL_API_URL=http://192.168.1.100:8080
```

### BÆ°á»›c 2: CÃ i Ä‘áº·t dependencies

```bash
cd backend
npm install axios dotenv
```

---

## ğŸ¯ CÃ¡ch hoáº¡t Ä‘á»™ng

### 1. Flow láº¥y dá»¯ liá»‡u:

```
Frontend Request
    â†“
Backend Controller (depotController.ts)
    â†“
Depot API Service (depotApiService.ts)
    â†“
External API (/api/data/process/iContainerHub_Depot)
    â†“
Transform Data
    â†“
Return to Frontend
```

### 2. Authentication Flow:

```
1. Gá»i /api/data/util/gettokenNonAid â†’ Nháº­n token + reqtime
2. DÃ¹ng token Ä‘á»ƒ gá»i /api/data/process/iContainerHub_Depot
3. Náº¿u token háº¿t háº¡n (401/403) â†’ Tá»± Ä‘á»™ng láº¥y token má»›i
```

### 3. Fallback to Mock Data:

Náº¿u API thá»±c khÃ´ng kháº£ dá»¥ng, há»‡ thá»‘ng tá»± Ä‘á»™ng sá»­ dá»¥ng mock data Ä‘á»ƒ Ä‘áº£m báº£o á»©ng dá»¥ng váº«n hoáº¡t Ä‘á»™ng.

---

## ğŸ§ª Test API thá»±c

### Test báº±ng TypeScript:

```bash
cd backend
npx ts-node src/test-real-api.ts
```

### Káº¿t quáº£ mong Ä‘á»£i:

```
ğŸ§ª Testing Real Depot API Connection...
==================================================

1ï¸âƒ£ Testing Token Retrieval...
âœ… Token retrieved successfully

2ï¸âƒ£ Testing Raw Depot Data Retrieval...
âœ… Raw data retrieved successfully
ğŸ“Š Data structure: {...}

3ï¸âƒ£ Testing Transformed Depot Data...
âœ… Retrieved 12 depots

ğŸ“¦ Sample Depot:
{
  "id": "DEPOT001",
  "name": "DEPOT NAME",
  "location": "Location",
  ...
}

4ï¸âƒ£ Testing Statistics...
âœ… Statistics: {...}

5ï¸âƒ£ Testing Provinces...
âœ… Found 8 provinces: [...]

ğŸ‰ All tests completed!
```

---

## ğŸ“Š Format dá»¯ liá»‡u

### Input (tá»« API thá»±c):

API cÃ³ thá»ƒ tráº£ vá» nhiá»u format khÃ¡c nhau. Service sáº½ tá»± Ä‘á»™ng transform.

**VÃ­ dá»¥ format 1:**
```json
{
  "data": [
    {
      "depotId": "DP001",
      "depotName": "Depot A",
      "city": "HCM",
      "fullAddress": "123 Street",
      "containers": 100,
      "maxCapacity": 500
    }
  ]
}
```

**VÃ­ dá»¥ format 2:**
```json
[
  {
    "id": "DP001",
    "name": "Depot A",
    "location": "HCM",
    ...
  }
]
```

### Output (chuáº©n hÃ³a):

```json
{
  "id": "DEPOT001",
  "name": "Depot Name",
  "location": "Location",
  "address": "Full Address",
  "image": "https://...",
  "containerCount": 100,
  "capacity": 500,
  "status": "active",
  "province": "Province Name"
}
```

---

## ğŸ”„ Transform Logic

File `depotApiService.ts` cÃ³ hÃ m `transformDepotData()` Ä‘á»ƒ chuyá»ƒn Ä‘á»•i dá»¯ liá»‡u:

```typescript
transformDepotData(apiData: any): any[] {
  // Mapping cÃ¡c field tá»« API sang format chuáº©n
  return depots.map((depot: any, index: number) => ({
    id: depot.id || depot.depotId || `DEPOT${index}`,
    name: depot.name || depot.depotName || 'Unknown',
    location: depot.location || depot.city || '',
    address: depot.address || depot.fullAddress || '',
    containerCount: depot.containerCount || depot.containers || 0,
    capacity: depot.capacity || depot.maxCapacity || 0,
    // ...
  }));
}
```

**âš ï¸ LÆ°u Ã½:** Báº¡n cáº§n Ä‘iá»u chá»‰nh mapping nÃ y dá»±a trÃªn cáº¥u trÃºc thá»±c táº¿ cá»§a API.

---

## ğŸ› Troubleshooting

### 1. KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c API

**Lá»—i:** `Failed to get token`

**Giáº£i phÃ¡p:**
- Kiá»ƒm tra `EXTERNAL_API_URL` trong `.env`
- Verify API endpoint cÃ³ accessible khÃ´ng
- Check network/firewall settings

### 2. Token háº¿t háº¡n

**Lá»—i:** `401 Unauthorized` hoáº·c `403 Forbidden`

**Giáº£i phÃ¡p:**
- Service tá»± Ä‘á»™ng refresh token
- Náº¿u váº«n lá»—i, check token API logic

### 3. Format dá»¯ liá»‡u khÃ´ng Ä‘Ãºng

**Lá»—i:** `Error transforming depot data`

**Giáº£i phÃ¡p:**
- Log raw data Ä‘á»ƒ xem cáº¥u trÃºc: `console.log(rawData)`
- Äiá»u chá»‰nh `transformDepotData()` function
- Update field mapping

### 4. API tráº£ vá» empty

**Lá»—i:** `No data received from API`

**Giáº£i phÃ¡p:**
- Há»‡ thá»‘ng tá»± Ä‘á»™ng fallback sang mock data
- Check API cÃ³ data khÃ´ng
- Verify request parameters

---

## ğŸ“ Äiá»u chá»‰nh Transform

Náº¿u API cá»§a báº¡n cÃ³ cáº¥u trÃºc khÃ¡c, sá»­a file `backend/src/services/depotApiService.ts`:

```typescript
transformDepotData(apiData: any): any[] {
  // BÆ°á»›c 1: Láº¥y array depots
  let depots = apiData.yourArrayField || [];
  
  // BÆ°á»›c 2: Map fields
  return depots.map((depot: any) => ({
    id: depot.yourIdField,
    name: depot.yourNameField,
    location: depot.yourLocationField,
    // ... mapping khÃ¡c
  }));
}
```

---

## ğŸ” Security Notes

1. **KhÃ´ng commit `.env` file** - ÄÃ£ thÃªm vÃ o `.gitignore`
2. **Token Ä‘Æ°á»£c tá»± Ä‘á»™ng refresh** khi háº¿t háº¡n
3. **API calls Ä‘Æ°á»£c log** Ä‘á»ƒ debug
4. **Error handling** Ä‘áº§y Ä‘á»§ vá»›i fallback

---

## ğŸ“ API Endpoints Ä‘Æ°á»£c sá»­ dá»¥ng

### External API (API thá»±c):

1. **Get Token:**
   - `GET /api/data/util/gettokenNonAid`
   - Returns: `{ token, reqtime }`

2. **Get Depot Data:**
   - `GET /api/data/process/iContainerHub_Depot`
   - Requires: `token`, `reqtime`
   - Returns: Depot data

### Backend API (Your API):

1. `GET /api/iContainerHub_Depot` - Get all depots
2. `GET /api/iContainerHub_Depot/:id` - Get depot by ID  
3. `GET /api/iContainerHub_Depot/statistics` - Get statistics
4. `GET /api/iContainerHub_Depot/provinces` - Get provinces

---

## ğŸš€ Deployment

Khi deploy lÃªn production:

1. Cáº­p nháº­t `EXTERNAL_API_URL` trong production environment
2. Set `NODE_ENV=production`
3. Verify API endpoint accessible tá»« server
4. Monitor logs Ä‘á»ƒ check API calls

---

## âœ¨ Features

âœ… Tá»± Ä‘á»™ng láº¥y vÃ  refresh token  
âœ… Fallback sang mock data náº¿u API fail  
âœ… Transform data sang format chuáº©n  
âœ… Error handling vÃ  retry logic  
âœ… Logging Ä‘áº§y Ä‘á»§ Ä‘á»ƒ debug  
âœ… Type-safe vá»›i TypeScript  
âœ… Singleton pattern cho service  

---

## ğŸ“– VÃ­ dá»¥ sá»­ dá»¥ng

### Trong Controller:

```typescript
import depotApiService from '../services/depotApiService';

// Láº¥y táº¥t cáº£ depots
const depots = await depotApiService.fetchDepots();

// Láº¥y statistics
const stats = await depotApiService.getStatistics();

// Láº¥y provinces
const provinces = await depotApiService.getProvinces();
```

### Response vá»›i source indicator:

```json
{
  "success": true,
  "count": 12,
  "data": [...],
  "source": "api"  // hoáº·c "mock" náº¿u dÃ¹ng mock data
}
```

---

Náº¿u cáº§n há»— trá»£ thÃªm hoáº·c cáº¥u trÃºc API thá»±c khÃ¡c, hÃ£y cho tÃ´i biáº¿t! ğŸš€
