# ğŸš€ API Services - Quick Reference

## Táº¥t cáº£ cÃ¡c API Ä‘Ã£ Ä‘á»“ng nháº¥t âœ…

### 1ï¸âƒ£ Token Management (Äá»“ng nháº¥t)

```javascript
// Táº¥t cáº£ services dÃ¹ng cÃ¹ng pattern
async getToken(reqid = "DefaultReqID") {
  // ğŸ”‘ Get token from gettokenNonAid
  // âœ… Save to this.token and this.reqtime
  // â±ï¸ Timeout: 10s
  // ğŸ“Š Log: token (first 20 chars), reqtime
  // âŒ Auto log errors with response status/data
}
```

### 2ï¸âƒ£ API Call Pattern (Äá»“ng nháº¥t)

```javascript
// Standard request
POST {apiUrl}/api/data/process/{Endpoint}
Headers: { "Content-Type": "application/json" }
Timeout: 30s
Body: {
  reqid: "EndpointName",
  token: "...",
  reqtime: "...",
  data: { appversion: "2023", ...specific }
}
```

### 3ï¸âƒ£ Error Handling (Äá»“ng nháº¥t)

```javascript
// All services auto-retry on 401/403
try {
  // Make API call
} catch (error) {
  if (status === 401 || status === 403) {
    // ğŸ”„ Auto reset token
    // ğŸ”„ Retry once
  }
  // âŒ Log detailed error
  throw error;
}
```

### 4ï¸âƒ£ Logging Format (Äá»“ng nháº¥t)

```
ğŸ”‘ Getting token for {reqid}...
âœ… Token retrieved successfully
ğŸ” Token (first 20 chars): xxxxx...
â° Reqtime: xxxxx

ğŸ“¡ Calling API: {endpoint}...
âœ… Data retrieved successfully
ğŸ“Š Response status: 200
ğŸ“Š Items count: 123

âŒ Failed to {action}: {error}
ğŸ“› Response status: 400
ğŸ“› Response data: {...}
```

---

## ğŸ“‹ API Endpoints

### Depot API
```javascript
import { DepotApiService } from './services/depotApiService';

const service = new DepotApiService();
const data = await service.getDepotData();
// Returns: Array of depot objects
```

**Endpoint**: `/api/data/process/iContainerHub_Depot`  
**ReqID**: `iContainerHub_Depot`  
**Returns**: `{ data: Depot[] }`

---

### Container API (List)
```javascript
const { ContainerApiService } = require('./services/containerApiService');

const service = new ContainerApiService();
const containers = await service.getListReUseNow();
// Returns: Array of container objects with rawApiData
```

**Endpoint**: `/api/data/process/GetListReUse_Now`  
**ReqID**: `GetListReUse_Now`  
**Returns**: `Container[]` with rawApiData

---

### Container API (Gate Out)
```javascript
const gateOutData = {
  HangTauID: 11,
  ContTypeSizeID: 14,
  SoChungTuNhapBai: "SGN0002222",
  DonViVanTaiID: 39503,
  SoXe: "93H-0000",
  NguoiTao: 111735,
  CongTyInHoaDon_PhiHaTang: 90750,
  CongTyInHoaDon: 90750,
  DepotID: 15,
  SoLuongCont: 1,
  HangHoa: -1
};

const result = await service.createGateOut(gateOutData);
// Returns: { success: boolean, data?: any, error?: string }
```

**Endpoint**: `/api/data/process/Create_GateOut_Reuse`  
**ReqID**: Multiple fallback strategy  
**Returns**: `{ success: boolean, data/error }`

---

## ğŸ”§ Common Patterns

### Pattern 1: Get Data
```javascript
async getData() {
  // 1. Check token
  if (!this.token) await this.getToken("ReqID");
  
  // 2. Make request
  const response = await axios.post(endpoint, payload, {
    timeout: 30000
  });
  
  // 3. Validate & return
  if (response.data) return response.data;
  return null;
}
```

### Pattern 2: Transform Data
```javascript
// All services use getValue() helper
getValue(field) {
  if (!field) return '';
  return field.v || field.r || field;
}

// Usage
const name = this.getValue(item.Name);
const id = this.getValue(item.ID);
```

### Pattern 3: Error Logging
```javascript
catch (error) {
  console.error('âŒ Failed:', error.message);
  if (error.response) {
    console.error('ğŸ“› Status:', error.response.status);
    console.error('ğŸ“› Data:', error.response.data);
  }
}
```

---

## âš™ï¸ Configuration

### Environment Variables
```bash
# .env file
EXTERNAL_API_URL=http://apiedepottest.gsotgroup.vn
```

### Timeouts
```javascript
Token Request: 10000ms (10s)
Data Request:  30000ms (30s)
```

---

## ğŸ§ª Testing

### Test any service
```bash
# Test script pattern
cd backend
node src/test-{service}.js

# Examples:
node src/test-gate-out.js
```

### Manual test with curl
```bash
# 1. Get token
curl -X POST http://apiedepottest.gsotgroup.vn/api/data/util/gettokenNonAid \
  -H "Content-Type: application/json" \
  -d '{"reqid":"XXX","data":{"appversion":"2023"}}'

# 2. Use token
curl -X POST http://apiedepottest.gsotgroup.vn/api/data/process/XXX \
  -H "Content-Type: application/json" \
  -d '{"reqid":"XXX","token":"...","reqtime":"...","data":{...}}'
```

---

## ğŸ“Š Standard Response Format

### Success
```javascript
{
  success: true,
  data: { ... }
}
```

### Error
```javascript
{
  success: false,
  error: "Error message",
  errorCode?: "404",
  statusCode?: 400,
  apiResponse?: { ... }
}
```

---

## ğŸ¯ Best Practices

1. âœ… **Always validate input** before API call
2. âœ… **Use getValue()** for API field extraction
3. âœ… **Check response.data** before using
4. âœ… **Log detailed info** for debugging
5. âœ… **Handle token expiration** automatically
6. âœ… **Set appropriate timeouts**
7. âœ… **Return consistent format**

---

## ğŸ” Debugging

### Check logs in order:
```
1. ğŸ”‘ Token request/response
2. ğŸ“¡ API call URL/payload
3. ğŸ“Š Response status/data
4. âŒ Any errors with status/data
```

### Common issues:
```
âŒ "Failed to get token"
   â†’ Check API_URL in .env
   â†’ Check network connectivity
   
âŒ "Invalid token"
   â†’ Token expired â†’ Auto-retry
   â†’ Wrong reqid â†’ Check endpoint docs
   
âŒ "Missing required fields"
   â†’ Validate input data
   â†’ Check rawApiData exists
```

---

## ğŸ“š Related Files

- `baseApiService.ts` - Base class (future)
- `depotApiService.ts` - Depot operations
- `containerApiService.js` - Container operations
- `API-STANDARDIZATION.md` - Full comparison
- `GATE-OUT-API-GUIDE.md` - Gate out details

---

## ğŸ’¡ Quick Tips

1. All APIs use **same token format**
2. All APIs have **same timeout** (10s/30s)
3. All APIs **auto-retry** on 401/403
4. All APIs **log consistently**
5. All APIs **return same format**
6. All APIs **handle errors same way**

**Bottom line**: Learn one API pattern â†’ Know all APIs! ğŸš€
